<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ë–ª–æ–∫–Ω–æ—Ç —Å jsonbin.io</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }
    textarea {
      width: 95vw;
      height: 40vh;
      resize: vertical;
    }
    input[type="text"] {
      width: 60vw;
      margin-bottom: 10px;
    }
    button {
      margin: 5px 5px 10px 0;
    }
    #binInfo {
      font-weight: bold;
      margin: 10px 0;
    }
    #output {
      margin-top: 20px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <header>
    <h1>üìù –î–ª—è –¥—Ä—É–∑–µ–π</h1>
  </header>

  <textarea id="input" placeholder="–ù–∞–ø–∏—à–∏ —Å–≤–æ—é –∑–∞–º–µ—Ç–∫—É..." style="width: 70vw;"></textarea>
  <br />
  <div id="output"></div>
  <br/>
  <button class="saveData">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  <button class="getData">üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
  <button class="createNew">üÜï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∫–æ–º–Ω–∞—Ç—É</button>
  <button class="clear">–û—Ç—á–∏—Å—Ç–∏—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
  <br/>

  <div id="binInfo">
    –¢–µ–∫—É—â–∞—è –∫–æ–º–Ω–∞—Ç–∞: <span id="currentBinId">‚Äì</span>
  </div>

  <label for="binInput">üîÅ –í–≤–µ—Å—Ç–∏ –Ω–æ–º–µ—Ä –∫–æ–º–Ω–∞—Ç—ã:<br/>–ï—Å–ª–∏ —Ç–µ–±—è –ø—Ä–∏–≥–ª–∞—Å–∏–ª–∏<br/>–ï—Å–ª–∏ —Ç—ã —Å–æ–∑–¥–∞–ª —Ç–æ –Ω–µ –Ω—É–∂–Ω–æ</label>
  <input type="text" id="binInput" placeholder="–í–≤–µ–¥–∏ BIN ID...">
  <br/>
  <button id="switchBin">üîÑ –í–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É</button>
  <br/>

  <input type="text" id="cryptoKay" placeholder="üîê –ö–ª—é—á —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è">

  <script>
    "use strict";

    document.addEventListener("DOMContentLoaded", () => {
      const API_KEY = '$2a$10$dTJJ5XSz58UYZx7bRB1t9.dH3BiqcWbirgqmqNcYYto6.8j00c2xi';
      const STORAGE_KEY = 'currentBinId';

      const input = document.querySelector('#input');
      const output = document.querySelector('#output');
      const saveData = document.querySelector('.saveData');
      const getData = document.querySelector('.getData');
      const createNew = document.querySelector('.createNew');
      const binInput = document.querySelector('#binInput');
      const switchBin = document.querySelector('#switchBin');
      const currentBinDisplay = document.querySelector('#currentBinId');
      const cryptoKay = document.querySelector('#cryptoKay');
      const clear = document.querySelector('.clear');

      let currentBinId = localStorage.getItem(STORAGE_KEY) || '';

      function updateBinDisplay() {
        currentBinDisplay.textContent = currentBinId || '‚Äì';
      }

      function strToBuffer(str) {
        return new TextEncoder().encode(str);
      }

      function bufferToStr(buffer) {
        return new TextDecoder().decode(buffer);
      }

      async function getKeyFromPassword(password) {
        const keyMaterial = await crypto.subtle.importKey(
          "raw",
          strToBuffer(password),
          { name: "PBKDF2" },
          false,
          ["deriveKey"]
        );

        return crypto.subtle.deriveKey(
          {
            name: "PBKDF2",
            salt: strToBuffer("my_salt"),
            iterations: 100000,
            hash: "SHA-256"
          },
          keyMaterial,
          {
            name: "AES-GCM",
            length: 256
          },
          false,
          ["encrypt", "decrypt"]
        );
      }

      async function encryptText(password, plainText) {
        const key = await getKeyFromPassword(password);
        const iv = crypto.getRandomValues(new Uint8Array(12));

        const encrypted = await crypto.subtle.encrypt(
          { name: "AES-GCM", iv },
          key,
          strToBuffer(plainText)
        );

        const combined = new Uint8Array(iv.length + encrypted.byteLength);
        combined.set(iv, 0);
        combined.set(new Uint8Array(encrypted), iv.length);

        return btoa(String.fromCharCode(...combined));
      }

      async function decryptText(password, encryptedText) {
        const combined = Uint8Array.from(atob(encryptedText), c => c.charCodeAt(0));
        const iv = combined.slice(0, 12);
        const data = combined.slice(12);
        const key = await getKeyFromPassword(password);
        const decrypted = await crypto.subtle.decrypt(
          { name: "AES-GCM", iv },
          key,
          data
        );
        return bufferToStr(decrypted);
      }

      async function updateNote(id, noteData) {
        try {
          const response = await fetch(`https://api.jsonbin.io/v3/b/${id}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'X-Access-Key': API_KEY
            },
            body: JSON.stringify(noteData)
          });
          if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏');
          alert('‚úÖ –ó–∞–º–µ—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞.');
        } catch (e) {
          console.error(e);
          alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–º–µ—Ç–∫–∏');
        }
      }

      async function loadNote(id) {
        try {
          const response = await fetch(`https://api.jsonbin.io/v3/b/${id}/latest`, {
            method: 'GET',
            headers: {
              'X-Access-Key': API_KEY,
              'Content-Type': 'application/json'
            }
          });

          if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ');

          const data = await response.json();
          const encrypted = data.record.message || '';
          const updatedAt = data.record.updatedAt || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';

          const decrypted = await decryptText(cryptoKay.value, encrypted);
          input.value = decrypted;

          output.textContent =
            /* üìã –¢–µ–∫—É—â–∞—è –∑–∞–º–µ—Ç–∫–∞:\n\n${decrypted}\n\n */`üïì –ü–æ—Å–ª–µ–¥–Ω–µ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ: ${new Date(updatedAt).toLocaleString('ru-RU')}`;
        } catch (e) {
          console.error(e);
          alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞–º–µ—Ç–∫–∏');
        }
      }

      saveData.addEventListener('click', async () => {
        if (!currentBinId) return alert("‚ùó –£–∫–∞–∂–∏—Ç–µ BIN ID.");
        if (!cryptoKay.value) return alert("‚ùó –£–∫–∞–∂–∏—Ç–µ –∫–ª—é—á —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è.");

        const encrypted = await encryptText(cryptoKay.value, input.value);
        const noteData = {
          message: encrypted,
          updatedAt: new Date().toISOString()
        };
        await updateNote(currentBinId, noteData);
      });

      
      clear.addEventListener('click', async () => { // –û–¢–ß–ò–°–¢–ö–ê –í–°–ï–ì–û –í –¢–û–ú –ß–ò–°–õ–ï –ò –°–ï–†–í–ï–†–ê
        if (!currentBinId) return alert("‚ùó –£–∫–∞–∂–∏—Ç–µ BIN ID.");
        if (!cryptoKay.value) return alert("‚ùó –£–∫–∞–∂–∏—Ç–µ –∫–ª—é—á —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è.");

        input.value = '';
        const encrypted = await encryptText(cryptoKay.value, input.value);
        const noteData = {
          message: encrypted,
          updatedAt: new Date().toISOString()
        };
        await updateNote(currentBinId, noteData);
      });

      getData.addEventListener('click', () => {
        if (!currentBinId) return alert("‚ùó –£–∫–∞–∂–∏—Ç–µ BIN ID.");
        if (!cryptoKay.value) return alert("‚ùó –£–∫–∞–∂–∏—Ç–µ –∫–ª—é—á —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è.");
        loadNote(currentBinId);
      });

      createNew.addEventListener('click', async () => {
        try {
          const response = await fetch('https://api.jsonbin.io/v3/b', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Access-Key': API_KEY
            },
            body: JSON.stringify({ message: '', updatedAt: new Date().toISOString() })
          });

          if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è BIN');

          const data = await response.json();
          currentBinId = data.metadata.id;
          localStorage.setItem(STORAGE_KEY, currentBinId);
          updateBinDisplay();
          alert(`‚úÖ –ù–æ–≤—ã–π BIN —Å–æ–∑–¥–∞–Ω: ${currentBinId}`);
          input.value = '';
        } catch (e) {
          console.error(e);
          alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ BIN');
        }
      });

      switchBin.addEventListener('click', () => {
        const newId = binInput.value.trim();
        if (!newId) return alert("‚ùó –í–≤–µ–¥–∏—Ç–µ BIN ID.");
        currentBinId = newId;
        localStorage.setItem(STORAGE_KEY, currentBinId);
        updateBinDisplay();
        alert(`üîÑ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–æ –Ω–∞ BIN: ${currentBinId}`);
        input.value = '';
      });

      updateBinDisplay();
    });
  </script>
</body>
</html>
